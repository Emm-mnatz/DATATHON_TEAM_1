---
title: "Effectiveness of HIV treatment combinations - Cox regression with time-varying covariates feat. `data.table`"
author: "Brandon Hao"
output: 
  md_document:
    variant: markdown_github
date: "2023-05-25"
---

```{r setup, include=FALSE}
# Set working directory
knitr::opts_chunk$set(
  root.dir = r"{C:\Users\brand\OneDrive\Desktop\Health Data Science\Datathon_team_2}"
  )
```

In this markdown, I'll demonstrate how to clean the data for a Cox regression with time-varying covarites. The data cleaning is arguably the most difficult part of the the analysis and we'll make plenty use of `data.table`'s convenient group-wise operations! I'll also demonstrate the process of fitting the Cox regression model and checking that if the proportional hazards assumption of the model is met. 

Without further ado, let's load in the necessary packages and read in the data. 

```{r initialisation, include = TRUE}
# Install and load libraries 
packages <- c('tidyverse', 'data.table', 'survial', 'DataExplorer', 'survsim', 'broom')
installed_packages <- packages %in% rownames(installed.packages())

if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

invisible(lapply(packages, require, character.only = TRUE))

# Set file paths  
if (!dir.exists('output')) dir.create(file.path('output'))

# Read HIV data
hiv <- file.path(r'{C:\Users\brand\OneDrive\Desktop\Health Data Science\Datathon_team_2\input/HealthGymV2_CbdrhDatathon_ART4HIV.csv}') %>% fread()
```

Let's have a look at our dataset. 

```{r initial look}
# Quick look! 
glimpse(hiv)
summary(hiv)
str(hiv)
```

Firstly, the names of the columns suck! Also, there are some variables which should be categorical variables. Let's clean up the names and transform variables into their proper type. 

```{r transformation}
# Change some names coz they suck
names(hiv) <- c(
  'vl', 'cd4', 'relcd4', 'gender', 'ethnic', 'base_drug_comb', 'ini', 'nnrti', 'pi', 'pk', 'vl_m', 'cd4_m', 'drug_m', 'id', 'time'
  )

# Transform columns into Boolean
boolean_cols <- hiv %>% select(pk:drug_m) %>% names()
hiv[, (boolean_cols) := lapply(.SD, as.logical), .SDcols = boolean_cols]

# Factorise certain columns and give sensible levels
factor_cols <- hiv %>% select(gender:pi) %>% names()
hiv[, (factor_cols) := lapply(.SD, as.factor), .SDcols = factor_cols]

levels(hiv$gender) <- c('male', 'female')
levels(hiv$ethnic) <- c('asian', 'afro', 'caucasian', 'other')
levels(hiv$base_drug_comb) <- c('ftc_tdf','3tc_abc', 'ftc_taf', 'drv_ftc_tdf', 'ftc_rtvb_tdf', 'other') 
levels(hiv$ini) <- c('dtg', 'ral', 'evg', 'not_applied')
levels(hiv$nnrti) <- c('nvp', 'efv', 'rpv', 'not_applied')
levels(hiv$pi) <- c('drv', 'rtvb', 'lpv', 'rtv', 'atv', 'not_applied')

# Make sure the format is properly transformed
str(hiv)
```

Let's have a look if our participants have consistent ethnicity and sex. 

```{r ethnicity and sex, results = FALSE}
# Check if participants have same ethnicity and sex
hiv[, .(nunique_gender = uniqueN(gender), nunique_ethn = uniqueN(ethnic)), by = id][, .(max_gender = max(nunique_gender), max_ethn = max(nunique_ethn))]
```

Just do some quick automated EDA. 

```{r}
# Plotting distribution of discrete variables
hiv %>% plot_bar(by = 'ethnic', nrow = 4, title = 'EDA - Ethnicity')
hiv %>% plot_bar(by = 'gender', nrow = 4, title = 'EDA - Gender')
hiv %>% plot_bar(by = 'base_drug_comb', nrow = 4, title = 'EDA - Drug Combo')
```

Let's move forward to analysis - let's relevel some variables for later analysis.

```{r}
# Re-level some variables
hiv$gender <- relevel(hiv$gender, ref = "male")
hiv$ethnic <- relevel(hiv$ethnic, ref = "caucasian")
hiv$base_drug_comb <- relevel(hiv$base_drug_comb, ref = "ftc_tdf")
hiv$ini <- relevel(hiv$ini, ref = "not_applied")
hiv$nnrti <- relevel(hiv$nnrti, ref = "not_applied")
hiv$pi <- relevel(hiv$pi, ref = "not_applied")
```

Let's separate out each drug into it's separate binary variables.

Transform the INI, NNRTI, PI variables too. 

```{r}
# Base drug transformation
hiv_trans <- hiv %>% 
  mutate(ftc = fifelse(grepl('ftc', base_drug_comb), 1, 0),
         tdf = fifelse(grepl('tdf', base_drug_comb), 1, 0),
         tc3 = fifelse(grepl('3tc', base_drug_comb), 1, 0),
         abc = fifelse(grepl('abc', base_drug_comb), 1, 0),
         taf = fifelse(grepl('taf', base_drug_comb), 1, 0),
         drv_base = fifelse(grepl('drv', base_drug_comb), 1, 0),
         rtvb_base = fifelse(grepl('rtvb', base_drug_comb), 1, 0),
         other_base = fifelse(grepl('other', base_drug_comb), 1, 0))

# INI drug transformation
hiv_trans <- hiv_trans %>% 
  mutate(dtg = fifelse(grepl('dtg', ini), 1, 0),
         ral = fifelse(grepl('ral', ini), 1, 0),
         evg = fifelse(grepl('evg', ini), 1, 0),
         ini_not_applied = fifelse(grepl('not_applied', ini), 1, 0))

# NNTRI drug transformation
hiv_trans <- hiv_trans %>% 
  mutate(nvp = fifelse(grepl('nvp', nnrti), 1, 0),
         efv = fifelse(grepl('efv', nnrti), 1, 0),
         rpv = fifelse(grepl('rpv', nnrti), 1, 0),
         nnrti_not_applied = fifelse(grepl('not_applied', nnrti), 1, 0))

# PI drug transformation
hiv_trans <- hiv_trans %>% 
  mutate(drv_extra_pi = fifelse(grepl('drv', pi), 1, 0),
         rtvb_extra_pi = fifelse(grepl('rtvb', pi), 1, 0),
         lpv = fifelse(grepl('lpv', pi), 1, 0),
         rtv = fifelse(grepl('rtv', pi), 1, 0),
         atv = fifelse(grepl('atv', pi), 1, 0),
         pi_not_applied = fifelse(grepl('not_applied', pi), 1, 0))
```

Let's extract the NTRI regimen from the base drug combination. 

```{r}
# Extract NRTI regimen
hiv_trans <- hiv_trans %>% 
  mutate(nrti_regimen = case_when(base_drug_comb %like% '3tc' ~ '3tc + abc',
                                  base_drug_comb %like% 'taf' ~ 'ftc + taf',
                                  base_drug_comb %like% 'tdf' ~ 'ftc + tdf',
                                  .default = 'none'))
```

Let's extract the PI regimen - regardless whether it's administered as part of the base regimen or as extra PI. 

```{r}
# Extract PI regimen
pi_cols <- c("drv_base", "rtvb_base", "drv_extra_pi", "rtvb_extra_pi", "lpv", "atv", "rtv")

hiv_trans <- hiv_trans %>% 
  mutate(pi_regimen = apply(hiv_trans[, ..pi_cols], 1, function(row) {
    
    # Get column names with 1 values
    pi_columns <- names(row[row == 1])
    
    # Replace "DRV_base" with "DRV" in the column names
    pi_columns <- gsub("drv_base", "drv", pi_columns)
    
    # Replace "DRV_extra_pi" with "DRV" in the column names
    pi_columns <- gsub("drv_extra_pi", "drv", pi_columns)
    
    # Replace "RTVB_base" with "RTVB" in the column names
    pi_columns <- gsub("rtvb_base", "rtvb", pi_columns)
    
    # Replace "RTVB_extra_pi" with "RTVB" in the column names
    pi_columns <- gsub("rtvb_extra_pi", "rtvb", pi_columns)
    
    # De-duplicate pi_columns (as DRV and RTVB may appear more than once)
    pi_columns <- unique(pi_columns)
    
    # Concatenate column names with pluses in between
    regimen <- paste(pi_columns, collapse = " + ")
    
    #Return the PI regimen
    ifelse(regimen == "", "none", regimen)
  }))
```

Let's extract the INI regimen 

```{r}
# Extract INI regimen
ini_cols <- c("evg", "dtg", "ral")

hiv_trans <- hiv_trans %>% 
  mutate(ini_regimen = apply(hiv_trans[, ..ini_cols], 1, function(row) {
      
    # Get column names with 1 values
    ini_columns <- names(row[row == 1])
    
    # Concatenate column names with pluses in between
    regimen <- paste(ini_columns, collapse = " + ")
    
    # Return the INI regimen
    ifelse(regimen == "", "none", regimen)
  }))
```

Let;s extract tge NNRTI regimen.

```{r}
# Extract NNRTI regimen
nntri_cols <- c("nvp", "efv", "rpv")

hiv_trans <- hiv_trans %>% 
  mutate(nntri_regimen = apply(hiv_trans[, ..nntri_cols], 1, function(row) {
  
    #Get column names with 1 values
    nnrti_columns <- names(row[row == 1])
    
    #Concatenate column names with pluses in between
    regimen <- paste(nnrti_columns, collapse = " + ")
    
    #Return the NRTI regimen
    ifelse(regimen == "", "none", regimen)
  }))
```



```{r}
hiv_cleaned <- hiv_trans %>% as.data.frame()

#Change the order of the columns
other_columns <- setdiff(names(hiv_cleaned), c("pk", "id", "time"))

#Rearrange the columns
hiv_cleaned[c(other_columns, c("pk", "id", "time"))] -> hiv_cleaned
  
#Save the processed data frame
# fwrite(hiv_cleaned, file.path(output_path, "processed_data_hiv.csv"))
```

Factorise the cleaned dataset.

```{r}
# Subset the columns we'd like to keep
cols_keep = c('vl', 'cd4', 'relcd4', 'gender', 'ethnic', 
              'nrti_regimen', 'other_base', 'pi_regimen', 'ini_regimen', 'nnrti_regimen', 'pk',
              'id', 'time', 'vl_m', 'cd4_m', 'drug_m')

hiv_trimmed <- hiv_cleaned[, cols_keep] %>% as.data.table()

# Factorise certain columns and give sensible levels
factor_cols <- hiv_trimmed %>% select(nrti_regimen:pk) %>% names()
hiv_trimmed[, (factor_cols) := lapply(.SD, as.factor), .SDcols = factor_cols]

str(hiv_trimmed)
```

```{r}
# Refactor variable
hiv_trimmed$nrti_regimen <- fct_relevel(
  hiv_trimmed$nrti_regimen, hiv_trimmed$nrti_regimen %>% table() %>% sort(decreasing = TRUE) %>% names()
  )

hiv_trimmed$other_base <- fct_relevel(
  hiv_trimmed$other_base, hiv_trimmed$other_base %>% table() %>% sort(decreasing = TRUE) %>% names()
  )

hiv_trimmed$pi_regimen <- fct_relevel(
  hiv_trimmed$pi_regimen, hiv_trimmed$pi_regimen %>% table() %>% sort(decreasing = TRUE) %>% names()
  )

hiv_trimmed$ini_regimen <- fct_relevel(
  hiv_trimmed$ini_regimen, hiv_trimmed$ini_regimen %>% table() %>% sort(decreasing = TRUE) %>% names()
  )

hiv_trimmed$nnrti_regimen <- fct_relevel(
  hiv_trimmed$nnrti_regimen, hiv_trimmed$nnrti_regimen %>% table() %>% sort(decreasing = TRUE) %>% names()
  )

hiv_trimmed$pk <- fct_relevel(
  hiv_trimmed$pk, hiv_trimmed$pk %>% table() %>% sort(decreasing = TRUE) %>% names()
  )

str(hiv_trimmed)
```

# Start analysis proper

How many people change their reigmen? 

```{r}
# How many patients change their regimen at least once?
npatient_regimen_change <- hiv_trimmed[, .N, by = .(id, nrti_regimen, other_base, pi_regimen, ini_regimen, nnrti_regimen, pk)] %>% 
  group_by(id) %>% 
  summarise(n_regimens = n()) %>% 
  filter(n_regimens > 1) %>% 
  nrow()

npatients <- uniqueN(hiv_trimmed$id)

npatients; npatient_regimen_change
```
Out of `r npatients`, `r npatient_regimen_change` changed regiments, representing `r npatient_regimen_change / (npatients) * 100 %>% round(2)`% of the cohort

Split dataset to 1) people over 1000 VL at time zero and 2) people below 500 CD4 at time zero


```{r}
# Get our VL dataset 
vl_id <- hiv_trimmed %>% filter(vl > 1000 & time == 0) %>% select(id) %>% unique()
vl <- hiv_trimmed %>% filter(id %in% vl_id$id) 

# Give outcome
vl <- vl %>% mutate(event = vl < 1000)

# For each person, mark the event as time
vl <- vl %>% mutate(event_timing = ifelse(event == TRUE, time, 59))

# Now select, each person's first eveng
vl <- vl %>% as.data.table()
min_event_id <- vl[, min(event_timing), by = id]

vl <- vl %>% left_join(min_event_id, by = 'id')
vl_trimmed <- vl %>% filter(time <= V1) %>% select(-event_timing)
```


```{r}
# Getting episodes
vl_trimmed_episode <- vl_trimmed %>% 
  mutate(episode = fifelse(
    (id == lag(id, default = first(id))) &  
      (nrti_regimen == lag(nrti_regimen, default = first(nrti_regimen))) &
    (other_base == lag(other_base, default = first(other_base))) &
    (pi_regimen == lag(pi_regimen, default = first(pi_regimen))) &
      (ini_regimen == lag(ini_regimen, default = first(ini_regimen))) &
      (nnrti_regimen == lag(nnrti_regimen, default = first(nnrti_regimen))) &
      (pk == lag(pk, default = first(pk))), 0, 1),
    episode_cumu = cumsum(episode))

# Getting start and stops
splits <- vl_trimmed_episode[, .(start = min(time), time = max(time)), by = .(id, episode_cumu)]
  
# Inner join
vl_subset <- vl_trimmed_episode %>% inner_join(splits, by = c('id', 'time', 'episode_cumu'))
vl_final <- vl_subset %>% rename(stop = time) %>% select(-episode, -episode_cumu)

vl_final <- vl_final %>% mutate(new_stop = stop + 1)
vl_final <- vl_final %>% mutate(new_stop = fifelse(new_stop > V1, V1, new_stop))
vl_final <- vl_final %>% mutate(event = fifelse(new_stop == V1, TRUE, FALSE)) 
vl_final <- vl_final %>% distinct(id, event, .keep_all = TRUE)
vl_final
```


```{r}
# test <- vl_final %>% mutate(new_stop = stop + 1)
# test <- test %>% mutate(new_stop = fifelse(new_stop > V1, V1, new_stop))
# test <- test %>% mutate(event = fifelse(new_stop == V1, TRUE, FALSE)) 
# test <- test %>% distinct(id, event, .keep_all = TRUE)
# 
# test %>% filter(start == new_stop)
# test %>% filter(id == 3)

```



# Build Cox model!!!!!!! 

```{r}
# First model
library(survival)
library(survsim)

mod1 <- coxph(Surv(start, new_stop, event) ~ relcd4 + gender + ethnic + nrti_regimen + other_base + pi_regimen + ini_regimen + nnrti_regimen + pk + cluster(id), vl_final)

results <- tidy(mod1, conf.int = TRUE, exp = T) 
results %>% fwrite(file.path(output_path, 'results.csv'))
results
```

```{r}
summary(mod1)
```



```{r}
library(sjPlot)

plot_model(mod1)
ggsave(file.path(output_path, 'output', 'results_image.png'))
```


